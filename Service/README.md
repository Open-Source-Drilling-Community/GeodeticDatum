# Service â€” Geodetic Datum HTTP API

Exposes a REST API for managing spheroids, geodetic datums, and batch conversions, backed by SQLite and powered by the core geodetic math from the Model project.

It also hosts a Model Context Protocol (MCP) server at `/GeodeticDatum/api/mcp` (Streamable HTTP transport) and `/GeodeticDatum/api/mcp/ws` (WebSockets) for agent integrations.

Base path: `/GeodeticDatum/api` (see `Service/Program.cs`). Swagger UI is served under `/GeodeticDatum/api/swagger`.

Container image name: `norcedrillinggeodeticdatumservice`.

## Purpose in the Solution

- Hosts the HTTP API used by clients (WebApp, automation, external services).
- Persists data in a local SQLite DB (`home/GeodeticDatum.db`) with lightweight DTO tables for efficient listing.
- Serves the merged OpenAPI schema generated by ModelSharedOut at `Service/wwwroot/json-schema/GeodeticDatumMergedModel.json` and surfaces it via Swagger UI.
- Produces a dependency OpenAPI file for ModelSharedOut in Debug builds (see `Service/Service.csproj` target `CreateSwaggerJson`).

## Installation

Prerequisites:
- .NET 8 SDK
- Optional: Docker

Local run:
- From repo root: `dotnet build` then `dotnet run --project Service/Service.csproj`
- Service listens with base path `/GeodeticDatum/api`. Open Swagger UI at `http://localhost:<port>/GeodeticDatum/api/swagger`.

Docker build/run:
- Build: `docker build -t norcedrillinggeodeticdatumservice Service` (honors `Dockerfile`)
- Run: `docker run -p 8080:8080 -e ASPNETCORE_URLS=http://+:8080 -v %CD%/home:/app/home norcedrillinggeodeticdatumservice`
- Open `http://localhost:8080/GeodeticDatum/api/swagger`

Notes:
- The service writes the SQLite file and usage history under `home/` at the repository root (see `SqlConnectionManager.HOME_DIRECTORY`, `Model/UsageStatistics.cs`). Mount this folder when containerized.
- Forwarded headers are enabled for `X-Forwarded-Proto` to play well behind reverse proxies.

## MCP Server

The MCP surface lives alongside the REST API:

- Streamable HTTP transport: `/GeodeticDatum/api/mcp`
- WebSocket transport: `/GeodeticDatum/api/mcp/ws`

### Streamable HTTP quick-start

1. **POST `initialize`** and advertise both `application/json` and `text/event-stream` in `Accept`:

   ```bash
   curl -i \
     -X POST \
     -H "Content-Type: application/json" \
     -H "Accept: application/json,text/event-stream" \
     -d '{
           "jsonrpc": "2.0",
           "id": "1",
           "method": "initialize",
           "params": {
             "protocolVersion": "2025-06-18",
             "clientInfo": { "name": "demo-shell", "version": "1.0.0" }
           }
         }' \
     http://localhost:5002/GeodeticDatum/api/mcp
   ```

   Capture the `Mcp-Session-Id` header from the response.

2. **Open the SSE stream**:

   ```bash
   curl -N \
     -H "Accept: text/event-stream" \
     -H "Mcp-Session-Id: <session id>" \
     http://localhost:5002/GeodeticDatum/api/mcp
   ```

3. **Send tool calls** with additional POST requests. Each POST must include `Accept: application/json,text/event-stream`, the `Mcp-Session-Id` header, and a JSON-RPC payload (e.g., `tools.call`).

### WebSocket transport

Use any MCP-aware WebSocket client against `ws://localhost:5002/GeodeticDatum/api/mcp/ws`. The server handles the handshake and streams responses over the socket.

All MCP tools are defined under `Service/Mcp/Tools/*` and correspond to the REST CRUD operations, conversions, and ping diagnostics.

## Usage Examples

All routes are under `/GeodeticDatum/api`.

Swagger UI
- GET `GET /GeodeticDatum/api/swagger`

Spheroid
- List IDs: `GET /GeodeticDatum/api/Spheroid`
- List MetaInfo: `GET /GeodeticDatum/api/Spheroid/MetaInfo`
- Get by ID: `GET /GeodeticDatum/api/Spheroid/{id}`
- List all (heavy): `GET /GeodeticDatum/api/Spheroid/HeavyData`
- Create: `POST /GeodeticDatum/api/Spheroid`
- Update: `PUT /GeodeticDatum/api/Spheroid/{id}`
- Delete: `DELETE /GeodeticDatum/api/Spheroid/{id}`

GeodeticDatum
- List IDs: `GET /GeodeticDatum/api/GeodeticDatum`
- List MetaInfo: `GET /GeodeticDatum/api/GeodeticDatum/MetaInfo`
- Get by ID: `GET /GeodeticDatum/api/GeodeticDatum/{id}`
- List light: `GET /GeodeticDatum/api/GeodeticDatum/LightData`
- List all (heavy): `GET /GeodeticDatum/api/GeodeticDatum/HeavyData`
- Create: `POST /GeodeticDatum/api/GeodeticDatum`
- Update: `PUT /GeodeticDatum/api/GeodeticDatum/{id}`
- Delete: `DELETE /GeodeticDatum/api/GeodeticDatum/{id}`

GeodeticConversionSet
- List IDs: `GET /GeodeticDatum/api/GeodeticConversionSet`
- List MetaInfo: `GET /GeodeticDatum/api/GeodeticConversionSet/MetaInfo`
- Get by ID: `GET /GeodeticDatum/api/GeodeticConversionSet/{id}`
- List light: `GET /GeodeticDatum/api/GeodeticConversionSet/LightData`
- List all (heavy): `GET /GeodeticDatum/api/GeodeticConversionSet/HeavyData`
- Create: `POST /GeodeticDatum/api/GeodeticConversionSet`
- Update: `PUT /GeodeticDatum/api/GeodeticConversionSet/{id}`
- Delete: `DELETE /GeodeticDatum/api/GeodeticConversionSet/{id}`

Usage statistics
- Get: `GET /GeodeticDatum/api/UsageStatistics`

Example (create a Spheroid):

```bash
curl -X POST \
  http://localhost:5002/GeodeticDatum/api/Spheroid \
  -H "Content-Type: application/json" \
  -d '{
        "MetaInfo": { "ID": "00000000-0000-0000-0000-000000000001" },
        "Name": "Custom WGS84",
        "Description": "Example",
        "SemiMajorAxis": { "ScalarValue": 6378137 },
        "InverseFlattening": { "ScalarValue": 298.257223563 }
      }'
```

## Dependencies

Internal:
- `Model` project: domain types and geodetic math (project reference in `Service/Service.csproj`).
- `ModelSharedOut`: generates `wwwroot/json-schema/GeodeticDatumMergedModel.json` consumed by Swagger UI (via `UseCustomSwagger`).

NuGet packages (selected):
- `Microsoft.Data.Sqlite`: SQLite storage.
- `Microsoft.OpenApi`, `Microsoft.OpenApi.Readers`: OpenAPI processing.
- `Swashbuckle.AspNetCore.*`: Swagger generation and UI.
- `OSDC.DotnetLibraries.*`: common/data management and domain dependencies used by Model.

Build integration:
- `CreateSwaggerJson` target (Debug) produces a schema file under `ModelSharedOut/json-schemas/GeodeticDatumFullName.json` for the merge step.

## Integration With the Solution

- WebApp consumes the merged OpenAPI / shared model to display and interact with the API.
- Model provides the algorithms and types the controllers and managers use.
- ModelSharedOut merges OpenAPI docs and generates a shared client/model consumed by WebApp and other clients; Service serves the merged JSON via Swagger UI.
- SQLite and the `home/` directory are shared across components (DB at `home/GeodeticDatum.db`, usage stats at `home/history.json`).

## Operational Notes

- Base path is enforced in `Service/Program.cs` with `app.UsePathBase("/GeodeticDatum/api")`.
- Reverse proxy friendly via `UseForwardedHeaders` (proto only).
- On DB structure mismatch, `SqlConnectionManager` generates a timestamped backup and recreates tables.



